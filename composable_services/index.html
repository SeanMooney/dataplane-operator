
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="OpenStack Data Plane Operator">
      
      
        <meta name="author" content="OpenStack Team">
      
      
        <link rel="canonical" href="https://openstack-k8s-operators.github.io/dataplane-operator/composable_services/">
      
      
        <link rel="prev" href="../deploying/">
      
      
        <link rel="next" href="../common_configurations/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.18">
    
    
      
        <title>Composable services - OpenStack Data Plane Operator</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#composable-services" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="OpenStack Data Plane Operator" class="md-header__button md-logo" aria-label="OpenStack Data Plane Operator" data-md-component="logo">
      
  <img src="../images/openstack-logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OpenStack Data Plane Operator
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Composable services
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/openstack-k8s-operators/dataplane-operator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    openstack-k8s-operators/dataplane-operator
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="OpenStack Data Plane Operator" class="md-nav__button md-logo" aria-label="OpenStack Data Plane Operator" data-md-component="logo">
      
  <img src="../images/openstack-logo.png" alt="logo">

    </a>
    OpenStack Data Plane Operator
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/openstack-k8s-operators/dataplane-operator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    openstack-k8s-operators/dataplane-operator
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Custom Resources
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Custom Resources
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../openstack_dataplane/" class="md-nav__link">
        OpenStackDataPlane
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../openstack_dataplanenode/" class="md-nav__link">
        OpenStackDataPlaneNode
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../openstack_dataplanerole/" class="md-nav__link">
        OpenStackDataPlaneRole
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../openstack_dataplaneservice/" class="md-nav__link">
        OpenStackDataPlaneService
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../design/" class="md-nav__link">
        Design
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../inheritance/" class="md-nav__link">
        Inheritance
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Deploying a DataPlane
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Deploying a DataPlane
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deploying/" class="md-nav__link">
        Deploying a DataPlane
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Composable services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Composable services
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dataplane-operator-provided-services" class="md-nav__link">
    dataplane-operator provided services
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interacting-with-the-openstackdataplaneservice-api" class="md-nav__link">
    Interacting with the OpenStackDataPlaneService API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composing-services" class="md-nav__link">
    Composing services
  </a>
  
    <nav class="md-nav" aria-label="Composing services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#developing-a-custom-service" class="md-nav__link">
    Developing a custom service
  </a>
  
    <nav class="md-nav" aria-label="Developing a custom service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customizing-the-ansible-runner-image-used-by-a-service" class="md-nav__link">
    Customizing the ansible-runner image used by a service
  </a>
  
    <nav class="md-nav" aria-label="Customizing the ansible-runner image used by a service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-a-new-custom-ansible-runner-image" class="md-nav__link">
    Building a new custom ansible-runner image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-extramounts" class="md-nav__link">
    Using ExtraMounts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enabling-a-custom-service" class="md-nav__link">
    Enabling a custom service
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_configurations/" class="md-nav__link">
        Common Configurations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../interacting_with_ansible/" class="md-nav__link">
        Interacting with Ansible
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dataplane-operator-provided-services" class="md-nav__link">
    dataplane-operator provided services
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interacting-with-the-openstackdataplaneservice-api" class="md-nav__link">
    Interacting with the OpenStackDataPlaneService API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composing-services" class="md-nav__link">
    Composing services
  </a>
  
    <nav class="md-nav" aria-label="Composing services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#developing-a-custom-service" class="md-nav__link">
    Developing a custom service
  </a>
  
    <nav class="md-nav" aria-label="Developing a custom service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customizing-the-ansible-runner-image-used-by-a-service" class="md-nav__link">
    Customizing the ansible-runner image used by a service
  </a>
  
    <nav class="md-nav" aria-label="Customizing the ansible-runner image used by a service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-a-new-custom-ansible-runner-image" class="md-nav__link">
    Building a new custom ansible-runner image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-extramounts" class="md-nav__link">
    Using ExtraMounts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enabling-a-custom-service" class="md-nav__link">
    Enabling a custom service
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="composable-services">Composable services<a class="headerlink" href="#composable-services" title="Permanent link">#</a></h1>
<p>Composable services with dataplane-operator provide a way for users to
customize services that are deployed on dataplane nodes. It is possible to
"compose" a set of services such that the dataplane deployment can be
customized in whichever ways are needed.</p>
<p>Composing services can take different forms. The interfaces in
dataplane-operator allow for:</p>
<ul>
<li>Enabling/disabling services</li>
<li>Ordering services</li>
<li>Developing custom services</li>
</ul>
<p>For the purposes of the interfaces in dataplane-operator, a service is an
ansible execution that manages a software deployment (installation,
configuration, execution, etc) on dataplane nodes. The ansible content that
makes up each service is defined by the service itself. Each service is a
resource instance of the
<a href="../openstack_dataplaneservice/"><code>OpenStackDataPlaneService</code></a> CRD.</p>
<h2 id="dataplane-operator-provided-services">dataplane-operator provided services<a class="headerlink" href="#dataplane-operator-provided-services" title="Permanent link">#</a></h2>
<p>dataplane-operator provides a default list of services that will be deployed on
dataplane nodes. The services list is set on the
<a href="../openstack_dataplanerole/#openstackdataplanerolespec"><code>OpenStackDataPlaneRole</code></a> CRD.</p>
<p>The default list of services as they will appear on the <code>services</code> field on an
<code>OpenStackDataPlaneRole</code> spec is:</p>
<pre><code>services:
  - configure-network
  - validate-network
  - install-os
  - configure-os
  - run-os
</code></pre>
<p>If the <code>services</code> field is ommitted from the <code>OpenStackDataPlaneRole</code> spec,
then the above list will be used.</p>
<p>The default list of services are reconciled during role reconciliation if the
service is in the role's service list.</p>
<hr />
<p><strong>NOTE</strong></p>
<p>Do not create a custom service with the same name as one of the default
services. The default service will overwrite the custom service with the same
name during role reconciliation.</p>
<hr />
<h2 id="interacting-with-the-openstackdataplaneservice-api">Interacting with the <code>OpenStackDataPlaneService</code> API<a class="headerlink" href="#interacting-with-the-openstackdataplaneservice-api" title="Permanent link">#</a></h2>
<p>The list of services available to be used by the dataplane can be seen by
getting the list of <code>OpenStackDataPlaneService</code> resources.</p>
<pre><code>oc get openstackdataplaneservice
</code></pre>
<p>If no custom services have been defined, the default avaiable services are
returned.</p>
<pre><code>NAME                AGE
configure-network   20h
configure-os        8d
install-os          8d
repo-setup          8d
run-os              8d
validate-network    8d
</code></pre>
<p>A service can be examined in more detail by looking at the YAML representation
of the resource.</p>
<pre><code>oc get openstackdataplaneservice configure-network -o yaml
</code></pre>
<p>In the <code>spec</code> output of the <code>configure-network</code> service, the ansible content
that is used by the service is shown. While the content is very similar to the
exact ansible syntax that will be used when the service executes ansible, it
may not always be proper ansible syntax. The API for defining the ansible
content of a service matches that of the
<a href="https://openstack-k8s-operators.github.io/openstack-ansibleee-operator/openstack_ansibleee/">'OpenStackAnsibleEE'</a>
CRD from
<a href="https://github.com/openstack-k8s-operators/openstack-ansibleee-operator">openstack-ansible-operator</a>.</p>
<p>The 'role' field on <code>OpenStackDataPlaneService</code> is the same API as the <code>role</code>
field on `OpenStackAnsibleEE'.</p>
<p>The 'play' field on <code>OpenStackDataPlaneService</code> is free form string content
that will be passed directly as playbook content when ansible executes.</p>
<p>Either <code>role</code> or <code>play</code> can define ansible content for a service, but both can
not be used in the same service.</p>
<h2 id="composing-services">Composing services<a class="headerlink" href="#composing-services" title="Permanent link">#</a></h2>
<p>This example will walk through developing and using a custom service.</p>
<h3 id="developing-a-custom-service">Developing a custom service<a class="headerlink" href="#developing-a-custom-service" title="Permanent link">#</a></h3>
<p>To create custom service, create a resource of kind
<a href="../openstack_dataplaneservice/"><code>OpenStackDataPlaneService</code></a>. User either the
'play' or 'role' field in spec to specify custom ansible content. These fields
are fully documented in the spec of the
<a href="https://openstack-k8s-operators.github.io/openstack-ansibleee-operator/openstack_ansibleee/">'OpenStackAnsibleEE'</a>
CRD from
<a href="https://github.com/openstack-k8s-operators/openstack-ansibleee-operator">openstack-ansible-operator</a>.</p>
<p>This example shows using the <code>play</code> field. Create a <code>hello-world.yaml</code> file
with the following contents:</p>
<pre><code>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: hello-world
spec:
  label: dataplane-deployment-hello-world
  openstackAnsibleEEImage: quay.io/openstack-k8s-operators/openstack-ansibleee-runner:latest
  play: |
    hosts: all
    tasks:
      - name: Hello World!
        shell: "echo Hello World!"
        register: output
      - name: Show output
        debug:
          msg: "{{ output.stdout }}"
</code></pre>
<p>Note that the <code>play</code> field is a string, and not YAML. However, it should be
proper ansible playbook syntax when parsed as YAML.</p>
<p>Create the service:</p>
<pre><code>oc apply -f hello-world.yaml
</code></pre>
<h4 id="customizing-the-ansible-runner-image-used-by-a-service">Customizing the ansible-runner image used by a service<a class="headerlink" href="#customizing-the-ansible-runner-image-used-by-a-service" title="Permanent link">#</a></h4>
<p>The <code>openstackAnsibleEEImage</code> field is the container image used by the
ansible-runner execution environment to execute ansible. The default image is
built with the content from
<a href="https://github.com/openstack-k8s-operators/edpm-ansible">edpm-ansible</a>.</p>
<p>In some cases, it may be necessary to customize the image used by the
ansible-runner execution environment in order to add additional ansible content
that might be needed (such as ansible roles or modules).</p>
<h5 id="building-a-new-custom-ansible-runner-image">Building a new custom ansible-runner image<a class="headerlink" href="#building-a-new-custom-ansible-runner-image" title="Permanent link">#</a></h5>
<p>Write a <code>Containerfile</code> that adds the needed custom content to the default
image:</p>
<pre><code>FROM quay.io/openstack-k8s-operators/openstack-ansibleee-runner:latest

COPY my_custom_role /usr/share/ansible/roles/my_custom_role
</code></pre>
<p>Build and push the image to a container registry:</p>
<pre><code>podman build -t quay.io/example_user/my_custom_image:latest .
podman push quay.io/example_user/my_custom_role:latest
</code></pre>
<p>In the <code>OpenStackDataPlaneService</code> YAML, specify the custom image for the
<code>openstackAnsibleEEImage</code> field:</p>
<pre><code>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: hello-world
spec:
  label: dataplane-deployment-hello-world
  openstackAnsibleEEImage: quay.io/example_user/my_custom_role:latest
  ...
</code></pre>
<h5 id="using-extramounts">Using ExtraMounts<a class="headerlink" href="#using-extramounts" title="Permanent link">#</a></h5>
<p>The <code>ExtraMounts</code> field in the
<a href="https://openstack-k8s-operators.github.io/dataplane-operator/openstack_dataplanerole/#nodesection"><code>NodeSection</code></a>
field can be used to mount custom content into the ansible-runner image. In
some cases, this is a simpler method to customize the image than having to
build an entirely new image.</p>
<h3 id="enabling-a-custom-service">Enabling a custom service<a class="headerlink" href="#enabling-a-custom-service" title="Permanent link">#</a></h3>
<p>To add a custom service to be executed as part of an <code>OpenStackDataPlaneRole</code>
deployment, add the service name to the <code>services</code> field list on the role. Add
the service name in the order that it should be executed relative to the other
services. This example shows adding the <code>hello-world</code> service as the first
service to execute for the <code>edpm-compute</code> role.</p>
<pre><code>apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlane
metadata:
  name: openstack-edpm
spec:
  roles:
    edpm-compute:
      services:
        - hello-world
        - configure-network
        - validate-network
        - install-os
        - configure-os
        - run-os
</code></pre>
<p>When customizing the services list, the default list of services must be
reproduced and then customized if the intent is to still deploy those services.
If just the <code>hello-world</code> service was listed in the list, then that is the only
service that would be deployed.</p>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      2023-07-04
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["search.suggest", "search.highlight", "search.share"], "search": "../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.220ee61c.min.js"></script>
      
    
  </body>
</html>